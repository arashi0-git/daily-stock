name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  frontend:
    name: Frontend Quality Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check frontend sources
        id: frontend_check
        run: |
          if git ls-files frontend --error-unmatch > /dev/null 2>&1; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Skip frontend job
        if: steps.frontend_check.outputs.present == 'false'
        run: echo "frontend/ が無いためフロントエンドジョブをスキップします"
      - uses: actions/setup-node@v4
        if: steps.frontend_check.outputs.present == 'true'
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        if: steps.frontend_check.outputs.present == 'true'
        run: npm install
      - name: Lint
        if: steps.frontend_check.outputs.present == 'true'
        run: npm run lint:frontend
      - name: Type check
        if: steps.frontend_check.outputs.present == 'true'
        run: npm run typecheck:frontend
      - name: Unit tests
        if: steps.frontend_check.outputs.present == 'true'
        run: npm run test:frontend
      - name: Architecture check
        if: steps.frontend_check.outputs.present == 'true'
        run: npm run deps:graph

  backend:
    name: Backend Quality Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check backend sources
        id: backend_check
        run: |
          if [ -f backend/pyproject.toml ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Skip backend job
        if: steps.backend_check.outputs.present == 'false'
        run: echo "backend が無いためバックエンドジョブをスキップします"
      - uses: actions/setup-python@v5
        if: steps.backend_check.outputs.present == 'true'
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/pyproject.toml
      - name: Install dependencies
        if: steps.backend_check.outputs.present == 'true'
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Ruff
        if: steps.backend_check.outputs.present == 'true'
        run: backend/scripts/run_ruff.sh
      - name: Format check
        if: steps.backend_check.outputs.present == 'true'
        run: backend/scripts/run_formatter.sh --check
      - name: mypy
        if: steps.backend_check.outputs.present == 'true'
        run: backend/scripts/run_mypy.sh
      - name: pytest
        if: steps.backend_check.outputs.present == 'true'
        env:
          DAILY_STOCK_JWT_SECRET_KEY: "test_secret_key"
          DAILY_STOCK_POSTGRES_USER: "postgres"
          DAILY_STOCK_POSTGRES_PASSWORD: "postgres"
          DAILY_STOCK_POSTGRES_DB: "daily_stock_test"
        run: backend/scripts/run_pytest.sh
      - name: Layer check
        if: steps.backend_check.outputs.present == 'true'
        run: backend/scripts/run_architecture_check.sh
